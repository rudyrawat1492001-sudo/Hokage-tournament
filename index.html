<script>
/* =======================
   TOURNAMENT STATE
======================= */
let stage = "LEAGUE"; // LEAGUE | QF | SF | FINAL

let allMatches = [];
let matchIndex = 0;

let qfMatches = [];
let qfIndex = 0;
let sfPlayers = [];
let finalPlayers = [];

let currentMatch = [];
let positions = [null,null,null,null];

/* =======================
   PLAYERS & DATA
======================= */
const players = [
"Naruto","Kakashi","Sai","Sakura","Neji","Rocklee","Tenten","Might Guy",
"Shikamaru","Ino","Choji","Asuma","Kiba","Shino","Hinata","Kurenai",
"Sasuke","Seuigtsu","Karin","Jugo","Deidara","Hidan","Sasori","Tobi",
"Itachi","Kisame","Shizune","Kakuzu","Konan","Pain","Garaa","Temari",
"Kankuro","Chiyo","Yamato","Hiruko","Tsunade","Jiraiya","Kabuto",
"Orochimaru","Minato","Small Obito","Small Kakashi"
];

let data = {};
players.forEach(p=>{
  data[p]={wins:0,loss:0,points:0,matches:0};
});

/* =======================
   UTILITIES
======================= */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    let j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

/* =======================
   LEAGUE MATCH GENERATION
======================= */
function generateAllLeagueMatches(){
  let count = {};
  players.forEach(p=>count[p]=0);
  allMatches = [];

  while(true){
    let pool = players.filter(p=>count[p]<4);
    if(pool.length < 4) break;

    shuffle(pool);
    let match = pool.slice(0,4);
    match.forEach(p=>count[p]++);
    allMatches.push(match);
  }
}

function startTournament(){
  stage = "LEAGUE";
  generateAllLeagueMatches();
  matchIndex = 0;
  renderMatchList();
  loadNextMatch();
}

/* =======================
   LOAD MATCHES
======================= */
function loadNextMatch(){
  if(matchIndex >= allMatches.length){
    alert("League Complete âœ…");
    startQuarterFinals();
    return;
  }
  currentMatch = allMatches[matchIndex];
  positions = [null,null,null,null];
  renderMatchList();
  renderMatch();
}

/* =======================
   MATCH LIST UI
======================= */
function renderMatchList(){
  let box = document.getElementById("matchList");
  box.innerHTML="";
  allMatches.forEach((m,i)=>{
    let div=document.createElement("div");
    div.style.border="1px solid #444";
    div.style.padding="6px";
    div.style.margin="4px 0";
    if(i===matchIndex) div.style.background="rgba(255,215,0,0.2)";
    if(i<matchIndex) div.style.opacity="0.5";
    div.innerHTML=`<b>Match ${i+1}</b> : ${m.join(" vs ")} ${i<matchIndex?"âœ…":""}`;
    box.appendChild(div);
  });
}

/* =======================
   RENDER MATCH
======================= */
function renderMatch(){
  let area=document.getElementById("matchArea");
  area.innerHTML="";
  currentMatch.forEach(p=>{
    area.innerHTML+=`
      <div class="player">
        <b>${p}</b><br>
        <button onclick="assign('${p}',0)">ğŸ¥‡</button>
        <button onclick="assign('${p}',1)">ğŸ¥ˆ</button>
        <button onclick="assign('${p}',2)">ğŸ¥‰</button>
        <button onclick="assign('${p}',3)">ğŸ˜µ</button>
      </div>`;
  });
  area.innerHTML+=`<br><button onclick="finalize()">Set Result âœ”ï¸</button>`;
}

function assign(player,pos){
  if(positions.includes(player)){alert("Already assigned");return;}
  if(positions[pos]){alert("Position taken");return;}
  positions[pos]=player;
}

/* =======================
   FINALIZE (ğŸ”¥ SINGLE SOURCE OF TRUTH)
======================= */
function finalize(){
  if(currentMatch.length===0) return;
  if(positions.includes(null)){alert("Assign all positions");return;}

  const points=[2,1,0,-1];

  positions.forEach((p,i)=>{
    data[p].matches++;
    data[p].points+=points[i];
    if(i===0) data[p].wins++;
    else data[p].loss++;
  });

  renderBoard();

  /* ğŸ”´ KNOCKOUT FLOW */
  if(stage!=="LEAGUE"){
    let winner=positions[0];

    if(stage==="QF"){
      sfPlayers.push(winner);
      qfIndex++;
      if(qfIndex<qfMatches.length){
        loadKnockoutMatch();
      }else{
        stage="SF";
        loadKnockoutMatch();
      }
    }
    else if(stage==="SF"){
      finalPlayers=[...sfPlayers];
      stage="FINAL";
      loadKnockoutMatch();
    }
    else if(stage==="FINAL"){
      alert("ğŸ† CHAMPION : "+winner);
    }
    return;
  }

  /* ğŸŸ¢ LEAGUE NEXT */
  matchIndex++;
  loadNextMatch();
}

/* =======================
   TOP 16 + KNOCKOUT
======================= */
function getTop16(){
  return Object.entries(data)
    .sort((a,b)=>b[1].points-a[1].points||b[1].wins-a[1].wins)
    .slice(0,16).map(e=>e[0]);
}

function startQuarterFinals(){
  let t=getTop16();
  qfMatches=[
    [t[0],t[7],t[8],t[15]],
    [t[1],t[6],t[9],t[14]],
    [t[2],t[5],t[10],t[13]],
    [t[3],t[4],t[11],t[12]]
  ];
  stage="QF";
  qfIndex=0;
  sfPlayers=[];
  loadKnockoutMatch();
}

function loadKnockoutMatch(){
  if(stage==="QF") currentMatch=qfMatches[qfIndex];
  else if(stage==="SF") currentMatch=sfPlayers;
  else if(stage==="FINAL") currentMatch=finalPlayers;
  positions=[null,null,null,null];
  renderMatch();
}

/* =======================
   LEADERBOARD
======================= */
function renderBoard(){
  let tbody=document.getElementById("board");
  tbody.innerHTML="";
  Object.entries(data)
  .sort((a,b)=>b[1].points-a[1].points||b[1].wins-a[1].wins)
  .forEach((e,i)=>{
    let tr=document.createElement("tr");
    if(i===0) tr.classList.add("highlight");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${e[0]}</td>
      <td>${e[1].wins}</td>
      <td>${e[1].loss}</td>
      <td>${e[1].points}</td>
      <td>${e[1].matches}</td>`;
    tbody.appendChild(tr);
  });
}

renderBoard();
</script>
